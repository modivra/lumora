<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redirecting...</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;min-height:100vh;display:grid;place-items:center;background:#fff;color:#111}
    .box{max-width:520px;padding:24px;text-align:center}
    .muted{opacity:.75;font-size:14px;margin-top:8px}
  </style>
</head>
<body>
  <div class="box">
    <div>redirecting you to amazon...</div>
    <div class="muted">this should only take a moment.</div>
  </div>

  <script>
    // same published Google Sheets CSV you were already using
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRMVMgGG9YfVAtXktobzjH0stbIFih2f97GFR2IjDoR8quVsvOaI_bK3aWPoRpnWR5KB3UpGtQZqJfj/pub?output=csv";

    function parseCsvLine(line) {
      // Minimal CSV parsing with support for quoted fields.
      const out = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          // handle escaped quote
          if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }

        if (ch === ',' && !inQuotes) {
          out.push(cur);
          cur = "";
          continue;
        }

        cur += ch;
      }
      out.push(cur);
      return out.map(s => s.trim());
    }

    async function fetchRedirectMap() {
      const res = await fetch(SHEET_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch sheet CSV");
      const csv = await res.text();

      const map = {};
      const lines = csv.split(/\r?\n/);

      for (const raw of lines) {
        const line = raw.trim();
        if (!line) continue;

        const parts = parseCsvLine(line);
        if (parts.length < 2) continue;

        const key = (parts[0] || "").replace(/^['"]|['"]$/g, "").trim();
        const url = parts.slice(1).join(",").replace(/^['"]|['"]$/g, "").trim();
        if (key && url) map[key] = url;
      }

      return map;
    }

    function pickRedirectTarget(map, urlParams) {
      // Try full key=value matches first, then bare keys.
      for (const [k, v] of urlParams.entries()) {
        const kv = `${k}=${v}`;
        if (map[kv]) return map[kv];
      }
      for (const [k] of urlParams.entries()) {
        if (map[k]) return map[k];
      }
      return null;
    }

    async function main() {
      const urlParams = new URLSearchParams(window.location.search);

      // no query params -> do nothing (keep the page simple)
      if (!urlParams.toString()) return;

      const map = await fetchRedirectMap();
      const target = pickRedirectTarget(map, urlParams);

      if (target) {
        // preserve history behavior similar to a normal redirect
        window.location.replace(target);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      main().catch(() => { /* fail silently */ });
    });
  </script>
</body>
</html>
